# Taskrunner

Taskrunner - это система обработки асинхронных задач с использованием RabbitMQ в качестве брокера сообщений. Система состоит из двух основных компонентов: Producer (производитель задач) и Consumer (потребитель задач).

## Ключевые особенности

- **Динамическое управление воркерами**: система автоматически масштабирует количество воркеров в зависимости от нагрузки (от 5 до 50 воркеров)
- **Автоматическое восстановление соединений**: встроенный механизм повторного подключения к RabbitMQ при сбоях
- **Dead Letter Exchange**: обработка проблемных сообщений с возможностью повторной попытки выполнения
- **Мониторинг состояния**: HTTP-эндпоинты для проверки работоспособности и статистики системы
- **Graceful Shutdown**: корректное завершение работы при получении сигналов остановки

## Требования

- Docker и Docker Compose
- RabbitMQ
- Redis

## Конфигурация

Перед запуском системы необходимо настроить конфигурационный файл `config.yaml`. Пример конфигурации доступен в репозитории.

### Параметры конфигурации

```yaml
# Адрес сервера, на котором запускается сервис
Server:
  addr: "0.0.0.0"
  port: ":8080"

# Параметры RabbitMQ
Rabbit:
  addr: "amqp://guest:guest@rabbitmq:5672/"

# Параметры Redis
Redis:
  addr: "redis:6379"
  user:
  password:
  db: 0
  maxRetries: 5
  dialTimeout: 10
  timeout: 5

# Параметры логирования
Logger:
  level: "debug"
```

## Запуск

### Подготовка к запуску

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/your-username/taskrunner.git
   cd taskrunner
   ```

2. Отредактируйте `config.yaml` в соответствии с вашими требованиями (при необходимости).

### Запуск с использованием Docker Compose

1. Запустите все сервисы с помощью Docker Compose:

   ```bash
   docker-compose up -d
   ```

2. Проверьте, что все контейнеры запущены:

   ```bash
   docker-compose ps
   ```

## Использование

### Отправка задач через API

Для отправки задач на обработку используйте REST API Producer:

```bash
curl -X POST http://localhost:8000/tasks -H "Content-Type: application/json" -d '{"url": "https://example.com"}'
```

### Проверка статуса задачи

```bash
curl http://localhost:8000/tasks/{task_id}
```

### Мониторинг

Доступны следующие эндпоинты для мониторинга:

- **Состояние системы**: `http://localhost:8080/health`

## Остановка

Для остановки сервисов используйте команду:

```bash
docker-compose down
```

## Архитектура системы

### Producer

Producer отвечает за прием HTTP-запросов, создание задач и отправку их в очередь RabbitMQ. Каждая задача получает уникальный идентификатор, который можно использовать для проверки статуса выполнения.

### Consumer

Consumer обрабатывает задачи из очереди RabbitMQ. Основные компоненты:

- **Worker Pool**: управляет пулом воркеров, динамически масштабируя их количество в зависимости от нагрузки
- **Worker**: обрабатывает отдельные сообщения из очереди, выполняет запросы к URL и сохраняет результаты в Redis
- **Dead Letter Queue**: обрабатывает сообщения, которые не удалось обработать после нескольких попыток

## Решение проблем

### Ошибка PRECONDITION_FAILED при запуске Producer

Если вы видите ошибку:

```bash
Exception (406) Reason: "PRECONDITION_FAILED - inequivalent arg 'x-dead-letter-exchange'..."
```

Это означает, что Producer и Consumer объявляют очередь с разными параметрами. Убедитесь, что оба компонента используют одинаковые настройки для Dead Letter Exchange.

### Не удается подключиться к RabbitMQ или Redis

Проверьте параметры подключения в `config.yaml` и убедитесь, что сервисы доступны и работают:

```bash
docker-compose ps
```

## Примечания по производительности

- Система автоматически масштабирует количество воркеров в зависимости от глубины очереди
- Для больших нагрузок рекомендуется увеличить `max_workers` в конфигурации
- Для очень больших нагрузок можно запустить несколько экземпляров Consumer
